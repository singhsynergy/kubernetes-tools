
## üõ°Ô∏è Step-by-Step: Secure RBAC Setup for a ServiceAccount

### **1Ô∏è‚É£ Create a Dedicated Namespace**

Keep the service account and its permissions isolated.

```bash
kubectl create namespace devops-tools
```

---

### **2Ô∏è‚É£ Create a Service Account**

This account represents your user or application (e.g., Jenkins, Terraform, or monitoring tool).

```bash
kubectl create serviceaccount devops-sa -n devops-tools
```

‚úÖ This creates:

* A `ServiceAccount` named `devops-sa`
* Automatically manages its token securely (in modern clusters)

---

### **3Ô∏è‚É£ Define a Role or ClusterRole**

Roles limit access **within a namespace**, while ClusterRoles give **cluster-wide access**.
üëâ Use **Role** whenever possible (principle of least privilege).

**Example: Role (Namespace Scoped)**

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: devops-tools
  name: devops-deployer
rules:
  - apiGroups: [""] # "" means core API group
    resources: ["pods", "services", "configmaps"]
    verbs: ["get", "list", "create", "update", "delete"]
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "list", "create", "update", "delete"]
```

---

### **4Ô∏è‚É£ Bind the Role to the Service Account**

This defines which service account can use the Role.

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: devops-deployer-binding
  namespace: devops-tools
subjects:
  - kind: ServiceAccount
    name: devops-sa
    namespace: devops-tools
roleRef:
  kind: Role
  name: devops-deployer
  apiGroup: rbac.authorization.k8s.io
```

---

### **5Ô∏è‚É£ Verify Permissions**

Check if your ServiceAccount has the right access:

```bash
kubectl auth can-i create pods --as=system:serviceaccount:devops-tools:devops-sa -n devops-tools
kubectl auth can-i delete deployments --as=system:serviceaccount:devops-tools:devops-sa -n devops-tools
```

---

### **6Ô∏è‚É£ (Optional) Create a Token for External Use**

For connecting from external tools (e.g., Jenkins pipeline):

```bash
kubectl create token devops-sa -n devops-tools
```

This prints a **JWT token**.
Use it in your CI/CD credentials or kubeconfig.

---

## üîê **Security Best Practices**

| Practice                                           | Description                                                                     |
| -------------------------------------------------- | ------------------------------------------------------------------------------- |
| **1. Least privilege**                             | Give access only to necessary resources and verbs. Avoid `cluster-admin`.       |
| **2. Namespace isolation**                         | Create one ServiceAccount per namespace or tool.                                |
| **3. Short-lived tokens**                          | Use `kubectl create token` (ephemeral tokens) instead of secrets.               |
| **4. Rotate tokens regularly**                     | Automate rotation using CI/CD secrets management.                               |
| **5. Use Role over ClusterRole**                   | Unless tool genuinely needs cluster-wide access.                                |
| **6. Enable audit logs**                           | Track ServiceAccount activities in API server logs.                             |
| **7. Avoid mounting tokens to pods unnecessarily** | In Deployment specs, set `automountServiceAccountToken: false` unless required. |

Example:

```yaml
automountServiceAccountToken: false
```

---

### ‚úÖ **Bonus: Cluster-Wide Role (If Needed)**

If the ServiceAccount must manage resources across namespaces (e.g., Terraform managing multiple namespaces):

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cluster-deployer
rules:
  - apiGroups: [""]
    resources: ["namespaces", "pods", "services", "configmaps"]
    verbs: ["get", "list", "create", "update", "delete"]
```

Bind with:

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cluster-deployer-binding
subjects:
  - kind: ServiceAccount
    name: devops-sa
    namespace: devops-tools
roleRef:
  kind: ClusterRole
  name: cluster-deployer
  apiGroup: rbac.authorization.k8s.io
```

